# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a Terraform configuration for deploying Nextcloud on Pilvio cloud infrastructure using a GitOps approach. Unlike traditional deployments that embed application configuration in Terraform, this setup:

1. Provisions infrastructure (VM, network, storage)
2. Configures VM to pull docker-compose configuration from a Git repository
3. Sets up automatic synchronization of configuration changes

## Key Differences from Traditional Setup

### Traditional Approach (tf-nextcloud)
- Docker-compose.yml embedded in Terraform cloud-init
- Application changes require Terraform runs
- Tightly coupled infrastructure and application config

### GitOps Approach (this repository)
- Infrastructure code only provisions resources
- Application configuration lives in separate Git repository
- Changes to app config don't require infrastructure changes
- Automatic updates via cron job

## Architecture

### Infrastructure Components
1. **VPC** - Network isolation
2. **Virtual Machine** - Ubuntu 22.04 with:
   - Docker and Docker Compose
   - Git for pulling configurations
   - UFW firewall, Fail2ban
   - Automated security updates
3. **S3 Bucket** - Object storage for Nextcloud
4. **Floating IP** - Public access point

### Application Stack (from separate repo)
- Caddy 2 (reverse proxy with auto-SSL)
- Nextcloud 28
- MariaDB 10.11
- Redis 7 (optional caching)

## Key Files

- `main.tf` - Infrastructure definitions with GitOps cloud-init
- `variables.tf` - Input variables including `nextcloud_config_repo`
- `outputs.tf` - Resource outputs
- `terraform.tfvars.example` - Example configuration

## Important Variables

### GitOps Specific
- `nextcloud_config_repo` - Git repository URL containing docker-compose.yml

### Infrastructure
- `apikey`, `billing_account_id` - Pilvio credentials
- `location` - Deployment location (tll01, jhvi, jhv02)
- `domain_name`, `letsencrypt_email` - SSL configuration

## Cloud-init Process

The VM initialization:
1. Installs Docker, Git, and security tools
2. Creates `.env` file with secrets from Terraform
3. Clones the nextcloud-configs repository
4. Runs setup script from the repository
5. Starts Docker Compose services
6. Sets up cron jobs for:
   - Configuration updates (every 30 minutes)
   - Automated backups (daily at 2 AM)

## Commands

### Terraform Workflow
```bash
terraform init
terraform plan
terraform apply
terraform destroy
```

### Post-Deployment
```bash
# SSH to server
ssh adminuser@<floating-ip>

# Check deployment status
sudo tail -f /var/log/cloud-init-output.log

# Manual config update
cd ~/nextcloud && git pull && docker-compose up -d
```

## Best Practices

1. **Secrets Management**
   - Passwords auto-generated by Terraform
   - Stored in `.env` file on VM (mode 0600)
   - Never commit secrets to Git

2. **Updates**
   - Infrastructure updates: Terraform apply
   - Application updates: Push to config repo
   - Emergency updates: SSH and manual git pull

3. **Monitoring**
   - Enable Slack alerts for production
   - Check health endpoint regularly
   - Monitor cloud-init completion

## Common Tasks

### Update Nextcloud Version
1. Update image tag in nextcloud-configs repo
2. Push to Git
3. Wait for auto-pull or SSH for immediate update

### Add Custom Configuration
1. Add PHP config files to nextcloud-configs/configs/
2. Push to Git
3. Configuration applied on next pull

### Scale Resources
1. Update VM variables in terraform.tfvars
2. Run `terraform apply`
3. Note: This recreates the VM

## Troubleshooting

### Deployment Issues
- Check cloud-init: `/var/log/cloud-init-output.log`
- Verify Git repository is accessible
- Ensure `.env` file was created correctly

### Application Issues
- Check Docker logs: `docker-compose logs -f`
- Verify all containers are running: `docker-compose ps`
- Test health endpoint: `curl https://domain/health`

## Important Notes

- State contains sensitive data (passwords)
- VM recreation loses local data (use S3 for persistence)
- DNS must point to floating IP before SSL works
- First boot takes 5-10 minutes for full setup